<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>View Accident</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="app">
  <div class="header">
    <a class="back" href="tracking.html" aria-label="Back">‚Üê</a>
    <h1>View Accident</h1>
  </div>

  <div class="card pad">
    <div class="kpi">
      <span class="tag"><strong class="stat">SOS</strong> alerts</span>
      <span class="tag">Accident Records</span>
    </div>

    <div class="grid" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <span class="badge alert">Emergency</span>
          <span>Auto on</span>
        </div>
        <a class="link small" href="alerts.html">Open list</a>
      </div>

      <div id="accident-list" class="list">
        <div class="small" style="opacity:.6">Fetching accident alerts...</div>
      </div>
    </div>
  </div>

  <div class="split" style="margin-top:14px">
    <button class="btn danger" onclick="alert('Hospital notified')">NOTIFY HOSPITAL</button>
    <button class="btn warn" onclick="alert('Police notified')">NOTIFY POLICE</button>
  </div>
</div>

<div class="nav">
  <div class="bar">
    <a class="tab" href="tracking.html">üè†</a>
    <a class="tab" href="alerts.html">üîî</a>
    <a class="tab active" href="accident.html">‚ö†Ô∏è</a>
  </div>
</div>

<script>
  const API_BASE = "https://pasafe-2.onrender.com";

  async function loadAccidents() {
    const listEl = document.getElementById("accident-list");
    listEl.innerHTML =
      "<div class='small' style='opacity:.7'>Loading...</div>";

    try {
      const res = await fetch(`${API_BASE}/api/alerts?type=accident`);
      if (!res.ok) throw new Error("HTTP " + res.status);

      const alerts = await res.json();

      if (!alerts.length) {
        listEl.innerHTML = "<div class='small'>No accident alerts yet.</div>";
        return;
      }

      alerts.sort((a, b) =>
        (Number(b.created_at) || 0) - (Number(a.created_at) || 0)
      );

      listEl.innerHTML = "";

      alerts.forEach(alert => {
        const item = document.createElement("div");
        item.className = "item";

        const created = alert.created_at
          ? new Date(Number(alert.created_at)).toLocaleString()
          : "Unknown time";

        const lat = alert.lat ?? "‚Äî";
        const lon = alert.lon ?? "‚Äî";

        let title = "Accident detected";
        if (alert.type === "fall_detected") title = "Fall detected";
        else if (alert.type === "sos_pressed") title = "SOS pressed";

        let route = "#";
        let attrs = 'class="link small"';
        if (alert.lat != null && alert.lon != null) {
          route = `https://www.google.com/maps/dir/?api=1&destination=${alert.lat},${alert.lon}`;
          attrs += ' target="_blank"';
        } else {
          attrs += ' style="pointer-events:none; opacity:.6"';
        }

        item.innerHTML = `
          <div class="l">
            <span class="badge alert">Accident</span>
            <div>
              <div>${title}</div>
              <div class="small">
                Device ${alert.device_id || "?"} ‚Ä¢ Lat ${lat}, Lon ${lon} ‚Ä¢ ${created}
              </div>
            </div>
          </div>
          <a href="${route}" ${attrs}>Route</a>
        `;

        listEl.appendChild(item);
      });

    } catch (err) {
      listEl.innerHTML = `
        <div class='small' style='color:#ffb4b4'>
          Error loading data: ${err.message}
        </div>`;
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadAccidents();
    setInterval(loadAccidents, 10000);
  });
</script>
</body>
</html>
