<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>View Accident</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

<div class="app">
  <div class="header">
    <a class="back" href="tracking.html" aria-label="Back">‚Üê</a>
    <h1>View Accident</h1>
  </div>

  <div class="card pad">
    <div class="kpi">
      <span class="tag"><strong class="stat">SOS</strong> alerts</span>
      <span class="tag">Accident Records</span>
    </div>

    <div id="accident-list" class="list" style="margin-top:12px">
      <div class="small" style="opacity:.6">Fetching accident alerts...</div>
    </div>
  </div>

  <!-- ACTION BUTTONS -->
  <div class="split" style="margin-top:14px">
    <button id="notifyHospital" class="btn danger">NOTIFY HOSPITAL</button>
    <button id="notifyPolice" class="btn warn">NOTIFY POLICE</button>
  </div>
</div>

<div class="nav">
  <div class="bar">
    <a class="tab" href="tracking.html">üè†</a>
    <a class="tab" href="alerts.html">üîî</a>
    <a class="tab active" href="accident.html">‚ö†Ô∏è</a>
  </div>
</div>

<script>
  const API_BASE = "https://pasafe-2.onrender.com";
  let selectedAlertId = null;

  async function loadAccidents() {
    const listEl = document.getElementById("accident-list");
    listEl.innerHTML = "<div class='small'>Loading...</div>";

    try {
      const res = await fetch(`${API_BASE}/api/alerts`);
      const alerts = await res.json();

      const accidentAlerts = alerts.filter(a =>
        a.type !== 'alcohol_alert'
      );

      if (!accidentAlerts.length) {
        listEl.innerHTML = "<div class='small'>No accident alerts yet.</div>";
        return;
      }

      accidentAlerts.sort((a, b) =>
        (Number(b.created_at) || 0) - (Number(a.created_at) || 0)
      );

      listEl.innerHTML = "";

      accidentAlerts.forEach(alert => {
        const item = document.createElement("div");
        item.className = "item";
        item.style.cursor = "pointer";

        const created = new Date(alert.created_at).toLocaleString();
        const lat = alert.lat ?? "‚Äî";
        const lon = alert.lon ?? "‚Äî";

        item.innerHTML = `
          <div class="l">
            <span class="badge alert">Accident</span>
            <div>
              <div>${alert.type.replace('_',' ')}</div>
              <div class="small">
                Device ${alert.device_id} ‚Ä¢ ${created}
              </div>
            </div>
          </div>
        `;

        item.onclick = () => {
          document.querySelectorAll('.item')
            .forEach(el => el.style.background = "");
          item.style.background = "#1e2a3a";
          selectedAlertId = alert.id;
        };

        listEl.appendChild(item);
      });

      // auto-select latest
      selectedAlertId = accidentAlerts[0].id;
      listEl.firstChild.style.background = "#1e2a3a";

    } catch (err) {
      listEl.innerHTML = `<div class="small">Error loading alerts</div>`;
    }
  }

  async function notifyAuthority(authority) {
    if (!selectedAlertId) {
      alert("No alert selected");
      return;
    }

    try {
      const res = await fetch(`${API_BASE}/api/notify`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          alert_id: selectedAlertId,
          authority
        })
      });

      const data = await res.json();

      if (data.ok) {
        alert(`${authority.toUpperCase()} notified successfully`);
      } else {
        alert("Notification failed");
      }
    } catch {
      alert("Server error");
    }
  }

  document.getElementById("notifyHospital")
    .onclick = () => notifyAuthority("hospital");

  document.getElementById("notifyPolice")
    .onclick = () => notifyAuthority("police");

  document.addEventListener("DOMContentLoaded", loadAccidents);
</script>

</body>
</html>
