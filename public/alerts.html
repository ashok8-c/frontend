<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Emergency Alerts</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

<div class="app">
  <div class="header">
    <a class="back" href="tracking.html" aria-label="Back">‚Üê</a>
    <h1>Emergency Alerts</h1>
  </div>

  <div class="card pad">
    <div class="row" style="justify-content:space-between">
      <span class="tag">Live Alert Feed</span>
      <a class="link small" href="#" id="export-link">Export</a>
    </div>

    <div id="alerts-list" class="list" style="margin-top:10px">
      <div class="small" style="opacity:0.6">Fetching alerts...</div>
    </div>
  </div>
</div>

<div class="nav">
  <div class="bar">
    <a class="tab" href="tracking.html">üè†</a>
    <a class="tab active" href="alerts.html">üîî</a>
    <a class="tab" href="accident.html">‚ö†Ô∏è</a>
    <a class="tab" href="analytics.html">üìä</a>
  </div>
</div>

<script>
  const API_BASE = "https://pasafe-2.onrender.com";
  let latestAlerts = [];

  async function fetchAllAlerts() {
    const res = await fetch(`${API_BASE}/api/alerts`);
    if (!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();
    return Array.isArray(data) ? data : [];
  }

  function mapAlertType(a) {
    if (a.type === "alcohol_alert") {
      return { label: "Alcohol Alert", badge: "", notify: "POLICE" };
    }
    return { label: "Accident Detected", badge: "alert", notify: "HOSPITAL" };
  }

  function renderAlerts(alerts) {
    const container = document.getElementById("alerts-list");
    container.innerHTML = "";

    if (!alerts.length) {
      container.innerHTML = "<div class='small'>No alerts yet.</div>";
      return;
    }

    alerts.forEach(a => {
      const created = a.created_at
        ? new Date(Number(a.created_at)).toLocaleString()
        : "Time unknown";

      const typeInfo = mapAlertType(a);
      const badgeClass = typeInfo.badge ? "badge alert" : "badge";

      const mapLink =
        a.lat != null && a.lon != null
          ? `https://maps.google.com/?q=${a.lat},${a.lon}`
          : "#";

      const item = document.createElement("div");
      item.className = "item";
      item.innerHTML = `
        <div class="l">
          <span class="${badgeClass}">${typeInfo.label}</span>
          <div>
            <div>Device ${a.device_id ?? "-"}</div>
            <div class="small">${created}</div>
          </div>
        </div>
        <a class="link small"
           href="${mapLink}"
           target="_blank">MAP</a>
      `;
      container.appendChild(item);
    });
  }

  function exportAlerts() {
    if (!latestAlerts.length) {
      alert("No alerts to export");
      return;
    }

    const headers = ["id","device_id","type","lat","lon","created_at"];
    const rows = latestAlerts.map(a => [
      a.id,
      a.device_id,
      a.type,
      a.lat ?? "",
      a.lon ?? "",
      a.created_at ? new Date(Number(a.created_at)).toISOString() : ""
    ]);

    const csv = [headers, ...rows].map(r => r.join(",")).join("\n");
    const blob = new Blob([csv], { type: "text/csv" });

    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = "alerts.csv";
    link.click();
    URL.revokeObjectURL(url);
  }

  async function loadAlerts() {
    const container = document.getElementById("alerts-list");
    container.innerHTML =
      "<div class='small' style='opacity:.7'>Loading alerts...</div>";

    try {
      const alerts = await fetchAllAlerts();

      alerts.sort((a, b) =>
        (Number(b.created_at) || 0) - (Number(a.created_at) || 0)
      );

      latestAlerts = alerts;
      renderAlerts(alerts);
    } catch (err) {
      container.innerHTML =
        `<div class="small" style="opacity:.8">Error loading alerts: ${err.message}</div>`;
    }
  }

  window.onload = () => {
    loadAlerts();

    document.getElementById("export-link").onclick = e => {
      e.preventDefault();
      exportAlerts();
    };

    setInterval(loadAlerts, 10000);
  };
</script>

</body>
</html>
