<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Emergency Alerts</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

<div class="app">
  <div class="header">
    <a class="back" href="tracking.html">‚Üê</a>
    <h1>Emergency Alerts</h1>
  </div>

  <div class="card pad">
    <div class="row" style="justify-content:space-between">
      <span class="tag">Live Alert Feed</span>
      <a class="link small" href="#" id="export-link">Export</a>
    </div>

    <div id="alerts-list" class="list" style="margin-top:10px">
      <div class="small" style="opacity:0.6">Fetching alerts‚Ä¶</div>
    </div>
  </div>
</div>

<div class="nav">
  <div class="bar">
    <a class="tab" href="tracking.html">üè†</a>
    <a class="tab active" href="alerts.html">üîî</a>
    <a class="tab" href="accident.html">‚ö†Ô∏è</a>
  </div>
</div>

<script>
const API_BASE = "https://pasafe-2.onrender.com";
let latestAlerts = [];

/* =====================
   HELPERS
===================== */

function getCategory(type) {
  if (type === "alcohol_alert") return "alcohol";
  if (type && type.startsWith("ble_")) return "accident";
  return "accident";
}

function notifyAuthority(kind) {
  alert(
    kind === "police"
      ? "Police notified (demo)"
      : "Hospital notified (demo)"
  );
}

/* =====================
   FETCH
===================== */

async function fetchAllAlerts() {
  const res = await fetch(`${API_BASE}/api/alerts`);
  const data = await res.json();
  return Array.isArray(data) ? data : [];
}

/* =====================
   RENDER
===================== */

function renderAlerts(alerts) {
  const container = document.getElementById("alerts-list");
  container.innerHTML = "";

  if (!alerts.length) {
    container.innerHTML = "<div class='small'>No alerts yet.</div>";
    return;
  }

  alerts.forEach(a => {
    const created = a.created_at
      ? new Date(Number(a.created_at)).toLocaleString()
      : "Unknown time";

    const category = getCategory(a.type);
    const isAlcohol = category === "alcohol";

    const hasLocation =
      a.lat !== null && a.lon !== null &&
      !isNaN(a.lat) && !isNaN(a.lon);

    const mapLink = hasLocation
      ? `https://www.google.com/maps?q=${a.lat},${a.lon}`
      : "#";

    const mapStyle = hasLocation
      ? "pointer-events:auto; opacity:1"
      : "pointer-events:none; opacity:.5";

    const item = document.createElement("div");
    item.className = "item";

    item.innerHTML = `
      <div class="l">
        <span class="badge ${isAlcohol ? "" : "alert"}">
          ${isAlcohol ? "Alcohol" : "Accident"}
        </span>
        <div>
          <div>Device ${a.device_id || "-"}</div>
          <div class="small">${created}</div>
        </div>
      </div>

      <div style="display:flex; gap:6px; align-items:center">
        <a class="link small"
           href="${mapLink}"
           target="_blank"
           style="${mapStyle}">
          MAP
        </a>

        <button class="btn small"
          onclick="notifyAuthority('${isAlcohol ? "police" : "hospital"}')">
          ${isAlcohol ? "Notify Police" : "Notify Hospital"}
        </button>
      </div>
    `;

    container.appendChild(item);
  });
}

/* =====================
   EXPORT
===================== */

function exportAlerts() {
  if (!latestAlerts.length) return alert("No alerts to export");

  const csv = [
    ["id","device_id","type","lat","lon","created_at"],
    ...latestAlerts.map(a => [
      a.id,
      a.device_id,
      a.type,
      a.lat ?? "",
      a.lon ?? "",
      a.created_at
        ? new Date(Number(a.created_at)).toISOString()
        : ""
    ])
  ].map(r => r.join(",")).join("\n");

  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "alerts.csv";
  a.click();
  URL.revokeObjectURL(url);
}

/* =====================
   INIT
===================== */

async function loadAlerts() {
  const alerts = await fetchAllAlerts();
  alerts.sort((a,b)=>(b.created_at||0)-(a.created_at||0));
  latestAlerts = alerts;
  renderAlerts(alerts);
}

window.onload = () => {
  loadAlerts();
  document.getElementById("export-link").onclick = e => {
    e.preventDefault();
    exportAlerts();
  };
  setInterval(loadAlerts, 10000);
};
</script>

</body>
</html>
