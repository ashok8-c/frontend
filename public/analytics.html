<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Analytics ‚Äì PASAFE</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

<div class="app">
  <div class="header">
    <a class="back" href="tracking.html">‚Üê</a>
    <h1>System Analytics</h1>
  </div>

  <!-- SUMMARY CARDS -->
  <div class="grid" style="margin-top:12px">
    <div class="card pad">
      <span class="tag">Total Alerts</span>
      <h2 id="total-alerts">‚Äî</h2>
    </div>

    <div class="card pad">
      <span class="tag">Accidents</span>
      <h2 id="accident-alerts">‚Äî</h2>
    </div>

    <div class="card pad">
      <span class="tag">Alcohol Alerts</span>
      <h2 id="alcohol-alerts">‚Äî</h2>
    </div>
  </div>

  <!-- RECENT ACTIVITY -->
  <div class="card pad" style="margin-top:14px">
    <span class="tag">Recent Activity</span>
    <div id="recent-list" class="list" style="margin-top:10px">
      <div class="small" style="opacity:.6">Loading analytics‚Ä¶</div>
    </div>
  </div>
</div>

<!-- bottom nav -->
<div class="nav">
  <div class="bar">
    <a class="tab" href="tracking.html">üè†</a>
    <a class="tab" href="alerts.html">üîî</a>
    <a class="tab" href="accident.html">‚ö†Ô∏è</a>
    <a class="tab active" href="analytics.html">üìä</a>
  </div>
</div>

<script>
const BACKEND = "https://pasafe-2.onrender.com";

/* =====================
   HELPERS
===================== */

function isAlcohol(a) {
  return a.type === "alcohol_alert";
}

function getLabel(a) {
  if (a.type === "alcohol_alert") return "Alcohol Detected";
  if (a.type === "fall_detected") return "Fall Detected";
  if (a.type === "sos_pressed") return "SOS Pressed";
  if (a.type && a.type.startsWith("ble_")) return "BLE Emergency";
  return "Emergency Alert";
}

/* =====================
   LOAD ANALYTICS
===================== */

async function loadAnalytics() {
  try {
    const res = await fetch(`${BACKEND}/api/alerts`);
    if (!res.ok) throw new Error("HTTP " + res.status);

    const alerts = await res.json();
    if (!Array.isArray(alerts)) throw new Error("Invalid data");

    const alcoholCount = alerts.filter(isAlcohol).length;
    const accidentCount = alerts.length - alcoholCount;

    document.getElementById("total-alerts").textContent = alerts.length;
    document.getElementById("alcohol-alerts").textContent = alcoholCount;
    document.getElementById("accident-alerts").textContent = accidentCount;

    renderRecent(alerts.slice(0, 5));
  } catch (err) {
    console.error(err);
    document.getElementById("recent-list").innerHTML =
      `<div class="small" style="color:#ffb4b4">Failed to load analytics</div>`;
  }
}

/* =====================
   RECENT ACTIVITY
===================== */

function renderRecent(alerts) {
  const box = document.getElementById("recent-list");
  box.innerHTML = "";

  if (!alerts.length) {
    box.innerHTML = "<div class='small'>No alerts yet.</div>";
    return;
  }

  alerts.forEach(a => {
    const time = a.created_at
      ? new Date(Number(a.created_at)).toLocaleString()
      : "Unknown time";

    const isAlcoholAlert = isAlcohol(a);

    const item = document.createElement("div");
    item.className = "item";
    item.innerHTML = `
      <div class="l">
        <span class="badge ${isAlcoholAlert ? "" : "alert"}">
          ${getLabel(a)}
        </span>
        <div>
          <div>Device ${a.device_id || "-"}</div>
          <div class="small">${time}</div>
        </div>
      </div>
    `;
    box.appendChild(item);
  });
}

/* =====================
   INIT
===================== */

window.onload = () => {
  loadAnalytics();
  setInterval(loadAnalytics, 10000);
};
</script>

</body>
</html>
