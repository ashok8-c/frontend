<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Live Vehicle Tracking</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

<div class="app">
  <div class="header">
    <a class="back" href="index.html" aria-label="Back">‚Üê</a>
    <h1>Live Vehicle Tracking</h1>
  </div>

  <!-- MAP CARD -->
  <div class="card pad" style="height:200px">
    <div class="row" style="justify-content:space-between">
      <span class="tag" id="device-label">Device ‚Ä¢ Map preview</span>
      <a class="link small" id="maps-link" href="#" target="_blank"
         style="pointer-events:none; opacity:.6">
        Open in Maps
      </a>
    </div>

    <div id="map-box"
      style="height:140px; border-radius:12px; border:1px dashed #1b304f;
             display:grid; place-items:center; color:#91a7c0; text-align:center;">
      <div>
        <div id="map-status">Loading latest location‚Ä¶</div>
        <div class="small" id="map-meta" style="margin-top:4px; opacity:.9"></div>
      </div>
    </div>
  </div>

  <!-- ALERTS -->
  <h2 style="margin:16px 0 8px">Alerts</h2>
  <div id="alerts-list" class="list">
    <div class="small" style="opacity:.7">Loading alerts‚Ä¶</div>
  </div>
</div>

<!-- NAV -->
<div class="nav">
  <div class="bar">
    <a class="tab active" href="tracking.html">üè†</a>
    <a class="tab" href="alerts.html">üîî</a>
    <a class="tab" href="accident.html">‚ö†Ô∏è</a>
    <a class="tab" href="analytics.html">üìä</a>
  </div>
</div>

<script>
const API_BASE = "https://pasafe-2.onrender.com";

/* =====================
   HELPERS
===================== */

function getDeviceIdFromQuery() {
  try {
    const params = new URLSearchParams(window.location.search);
    return params.get("device") || "1";
  } catch {
    return "1";
  }
}

function getAlertCategory(type) {
  if (type === "alcohol_alert") return "alcohol";
  if (type && type.startsWith("ble_")) return "accident";
  return "accident";
}

const DEVICE_ID = getDeviceIdFromQuery();

/* =====================
   MAP / LOCATION
===================== */

async function fetchLatest(deviceId) {
  try {
    const res = await fetch(`${API_BASE}/api/readings/latest/${deviceId}`);
    const data = await res.json();
    updateMapCard(data, deviceId);
  } catch {
    document.getElementById("map-status").textContent =
      "Unable to load location.";
  }
}

function updateMapCard(data, deviceId) {
  const status = document.getElementById("map-status");
  const meta = document.getElementById("map-meta");
  const label = document.getElementById("device-label");
  const mapLink = document.getElementById("maps-link");

  label.textContent = `Device ${deviceId} ‚Ä¢ Map preview`;

  if (!data || !data.lat || !data.lon) {
    status.textContent = "No data yet for this device.";
    meta.textContent = "";
    mapLink.style.pointerEvents = "none";
    mapLink.style.opacity = ".6";
    return;
  }

  status.textContent = `Lat ${data.lat}, Lon ${data.lon}`;
  meta.textContent =
    `Last update ‚Ä¢ ${new Date(Number(data.ts || Date.now())).toLocaleString()}`;

  mapLink.href = `https://www.google.com/maps?q=${data.lat},${data.lon}`;
  mapLink.style.pointerEvents = "auto";
  mapLink.style.opacity = "1";
}

/* =====================
   ALERTS
===================== */

async function loadAlerts() {
  const container = document.getElementById("alerts-list");
  container.innerHTML =
    `<div class="small" style="opacity:.7">Loading alerts‚Ä¶</div>`;

  try {
    const res = await fetch(`${API_BASE}/api/alerts`);
    const alerts = await res.json();

    const normalized = alerts.map(a => ({
      ...a,
      category: getAlertCategory(a.type)
    }));

    normalized.sort(
      (a, b) => (Number(b.created_at) || 0) - (Number(a.created_at) || 0)
    );

    renderAlerts(normalized.slice(0, 4));
  } catch {
    container.innerHTML =
      `<div class="small" style="opacity:.8">Failed to load alerts</div>`;
  }
}

function renderAlerts(alerts) {
  const container = document.getElementById("alerts-list");
  container.innerHTML = "";

  if (!alerts.length) {
    container.innerHTML =
      `<div class="small" style="opacity:.8">No recent alerts.</div>`;
    return;
  }

  alerts.forEach(alert => {
    const isAccident = alert.category === "accident";
    const created = alert.created_at
      ? new Date(Number(alert.created_at)).toLocaleTimeString()
      : "";

    const title = isAccident ? "Accident detected" : "Alcohol driving";
    const badge = isAccident ? "Accident" : "Alcohol";
    const link = isAccident ? "accident.html" : "alerts.html";

    const item = document.createElement("div");
    item.className = "item";

    item.innerHTML = `
      <div class="l">
        <span class="badge ${isAccident ? "alert" : ""}">${badge}</span>
        <div>
          <div>${title}</div>
          <div class="small">Device ${alert.device_id} ‚Ä¢ ${created}</div>
        </div>
      </div>
      <a class="link small" href="${link}">OPEN</a>
    `;

    container.appendChild(item);
  });
}

/* =====================
   INIT
===================== */

window.onload = () => {
  fetchLatest(DEVICE_ID);
  loadAlerts();
  setInterval(() => fetchLatest(DEVICE_ID), 5000);
  setInterval(loadAlerts, 8000);
};
</script>

</body>
</html>
